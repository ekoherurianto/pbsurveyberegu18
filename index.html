<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB SURVEY - Tournament Edition</title>
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
            --bg-body: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background: var(--bg-body); 
            margin: 0; padding: 10px; font-size: 13px; color: var(--text-main); 
        }

        .container { max-width: 600px; margin: auto; background: white; border-radius: 28px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        /* HERO SECTION */
        .hero { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 40px 20px; text-align: center; color: white; border-radius: 0 0 30px 30px;
        }
        .hero h1 { margin: 0; font-size: 26px; letter-spacing: 3px; font-weight: 900; }
        .hero p { opacity: 0.8; font-size: 14px; line-height: 1.6; margin-top: 10px; font-style: italic; }

        /* NAVIGATION */
        nav { display: grid; grid-template-columns: repeat(5, 1fr); background: #f8fafc; padding: 6px; border-bottom: 1px solid #e2e8f0; }
        nav button { border: none; background: none; padding: 12px 2px; font-size: 10px; font-weight: 800; cursor: pointer; color: var(--text-muted); border-radius: 12px; }
        nav button.active { background: white; color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        .content { padding: 15px; min-height: 500px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* KLASEMEN TABLE */
        .table-container { background: white; border: 1px solid #e2e8f0; border-radius: 20px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; color: var(--text-muted); font-size: 10px; padding: 15px 10px; text-transform: uppercase; }
        td { padding: 15px 10px; border-bottom: 1px solid #f1f5f9; text-align: center; font-weight: 600; }
        .team-name { text-align: left; padding-left: 15px; display: flex; align-items: center; }
        .rank-badge { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin-right: 8px; }
        .pts-pill { background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; font-size: 11px; }

        /* CARDS */
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 18px; padding: 18px; margin-bottom: 15px; }
        .match-score-badge { background: #f1f5f9; padding: 10px 18px; border-radius: 14px; font-size: 18px; font-weight: 900; color: var(--primary); }
        .match-score-badge.live { background: var(--primary); color: white; }

        /* INPUTS & BUTTONS */
        input, select { width: 100%; padding: 10px; border: 1.5px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; font-family: inherit; }
        .btn { padding: 12px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }

        /* OVERLAY */
        #editOverlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; padding: 20px; z-index: 100; overflow-y: auto; backdrop-filter: blur(5px); }
        .partai-box { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }

        .loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f1f5f9; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="globalLoader" class="loading-overlay"><div class="spinner"></div></div>

<div id="editOverlay">
    <div class="card" style="max-width: 500px; margin: auto;">
        <h3 id="editTitle" style="text-align:center; margin:0 0 15px 0;">Input Hasil</h3>
        <label style="font-size:10px; font-weight:bold;">JADWAL MATCH:</label>
        <input type="datetime-local" id="editTime">
        <div id="partaiInputs"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn" style="background:#eee" onclick="closeEdit()">Batal</button>
            <button class="btn btn-primary" style="flex:2" onclick="saveEdit()">Simpan Skor</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="tab-home" class="section active">
        <div class="hero">
            <h1>PB SURVEY</h1>
            <div style="font-size: 11px; letter-spacing: 4px; opacity: 0.6; margin-bottom: 15px;">TOURNAMENT JILID-18</div>
            <p>"Bukan tentang siapa yang paling kuat, tapi tentang siapa yang pantang menyerah. Junjung sportivitas, jalin persaudaraan!" <br> -- E-JP --<br></p>
            <div style="margin: 20px 0;">
            <img src="https://i.ibb.co.com/qFWt70Gd/pbsurvey18.jpg" alt="Poster Tournament" style="width: 100%; max-width: 300px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.2);">
			<button onclick="tab('tab-jadwal')" class="btn btn-primary" style="width: auto; padding: 10px 25px; margin-top: 15px; background: var(--accent);">Lihat Jadwal Match</button>
        </div>
        <div style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 11px;">
            Update Otomatis ‚Ä¢ Terakhir Sinkron: <span id="last-update">-</span>
        </div>
    </div>

    <nav>
        <button onclick="tab('tab-home')" id="b-tab-home" class="active">HOME</button>
        <button onclick="tab('tab-klasemen')" id="b-tab-klasemen">KLASEMEN</button>
        <button onclick="tab('tab-jadwal')" id="b-tab-jadwal">JADWAL</button>
        <button onclick="tab('tab-data')" id="b-tab-data">REGU</button>
        <button onclick="tab('tab-admin')" id="b-tab-admin">ADMIN</button>
    </nav>

    <div class="content">
        <div id="tab-klasemen" class="section">
            <h4 style="margin: 0 0 15px 5px; color: var(--primary);">üèÜ Klasemen Regu</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th align="left" style="padding-left:15px">REGU</th><th>M</th><th>W/L</th><th>SG</th><th>PTS</th></tr>
                    </thead>
                    <tbody id="v-klasemen"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-jadwal" class="section"><div id="v-jadwal"></div></div>

        <div id="tab-data" class="section"><div id="v-regu"></div></div>

        <div id="tab-admin" class="section">
            <div class="card">
                <h4 style="margin-top:0">üîë Login Admin</h4>
                <input type="password" id="pass" placeholder="Password Admin" oninput="checkPass()">
            </div>
            <div id="admin-tools" style="display:none;">
                <div class="card">
                    <h4>‚ûï Tambah Regu</h4>
                    <input type="text" id="t-name" placeholder="Nama Regu Baru">
                    <button class="btn btn-primary" onclick="addTeam()">Simpan Regu</button>
                </div>
                <div class="card">
                    <h4>‚öôÔ∏è Pengaturan Jadwal</h4>
                    <button class="btn" style="background:white; border:1px solid #ddd; color:var(--danger)" onclick="genJadwal()">Hapus & Buat Ulang Jadwal</button>
                </div>
                <div id="v-admin-matches"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzAheXkF6Ji6k4pQ8YcDdGsY-gR6mbk5tf1l9AQ_5ML9Pvt7BmsREwo6aWYKYBsgXad/exec"; // GANTI DENGAN URL ANDA
    const PW = "PB123";
    let db = { teams: [], matches: [] };
    let currentEditIdx = null;

    function showLoader() { document.getElementById('globalLoader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('globalLoader').style.display = 'none'; }

    async function sync(action, target, data = null) {
        showLoader();
        try {
            if (action === 'load') {
                const r = await fetch(`${API}?target=${target}`);
                return await r.json();
            } else {
                await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'saveAll', target, data }) });
                await loadAll();
            }
        } catch (e) { alert("Koneksi Error!"); }
        finally { hideLoader(); }
    }

    async function loadAll() {
        const [t, m] = await Promise.all([sync('load','Teams'), sync('load','Matches')]);
        db.teams = t ? t.slice(1).map(r => ({ name: r[0], players: JSON.parse(r[1] || "[]") })) : [];
        db.matches = m ? m.slice(1).map(r => ({ a: r[0], b: r[1], time: r[2], sa: r[3], sb: r[4], detail: r[5] ? JSON.parse(r[5]) : [] })) : [];
        document.getElementById('last-update').innerText = new Date().toLocaleTimeString('id-ID');
        render();
    }

    function render() {
        const isAdmin = document.getElementById('pass').value === PW;

        // KLASEMEN
        // --- KLASEMEN RENDER ---
let st = {}; 
db.teams.forEach(t => st[t.name] = { m:0, w:0, l:0, sg_w:0, sg_l:0, pts:0 });

db.matches.forEach(m => {
    // Cek jika pertandingan sudah ada skornya (tidak kosong)
    if(m.sa !== "" && m.sa !== null && m.sa !== undefined) {
        st[m.a].m++; 
        st[m.b].m++;

        // LOGIKA BARU: Menang = 3 Poin, Kalah = 0 Poin
        if(parseInt(m.sa) > parseInt(m.sb)) { 
            st[m.a].w++; 
            st[m.a].pts += 3; // Regu A Menang, dapat 3 Poin
            st[m.b].l++; 
        } else { 
            st[m.b].w++; 
            st[m.b].pts += 3; // Regu B Menang, dapat 3 Poin
            st[m.a].l++; 
        }

        // SG (Selisih Game) tetap dihitung berdasarkan jumlah kemenangan partai (2-1 atau 3-0)
        if(m.detail) {
            m.detail.forEach(p => {
                if(parseInt(p.scA) > parseInt(p.scB)) { 
                    st[m.a].sg_w++; st[m.b].sg_l++; 
                } else if(parseInt(p.scB) > parseInt(p.scA)) { 
                    st[m.b].sg_w++; st[m.a].sg_l++; 
                }
            });
        }
    }
});

// Urutkan berdasarkan: 1. PTS (Poin Menang), 2. SG (Selisih Game), 3. Head-to-Head (opsional)
const sorted = Object.keys(st).sort((a,b) => {
    if (st[b].pts !== st[a].pts) return st[b].pts - st[a].pts;
    return (st[b].sg_w - st[b].sg_l) - (st[a].sg_w - st[a].sg_l);
});

// Update tampilan ke tabel
document.getElementById('v-klasemen').innerHTML = sorted.map((k, idx) => `
    <tr>
        <td><div class="team-name"><span class="rank-badge">${idx+1}</span>${k}</div></td>
        <td>${st[k].m}</td>
        <td><span style="color:var(--accent)">${st[k].w}</span>/<span style="color:var(--danger)">${st[k].l}</span></td>
        <td>${st[k].sg_w - st[k].sg_l}</td>
        <td><span class="pts-pill" style="background:var(--accent)">${st[k].pts}</span></td>
    </tr>`).join('');

        // JADWAL
        document.getElementById('v-jadwal').innerHTML = db.matches.map(m => `
            <div class="card">
                <div style="font-size:13px; color:var(--text-muted); margin-bottom:10px;">üìÖ ${m.time ? new Date(m.time).toLocaleString('id-ID',{weekday: 'long',day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : 'Belum Terjadwal'}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1; font-weight:800;">${m.a}</div>
                    <div class="match-score-badge ${m.sa !== "" ? 'live' : ''}">${m.sa !== "" ? m.sa + ' - ' + m.sb : 'VS'}
					${m.lap ? `<div style="font-size:10px; font-weight:bold; color:var(--accent); margin-top:5px;">${m.lap}</div>` : ''}
					</div>
                    <div style="flex:1; text-align:right; font-weight:800;">${m.b}</div>
                </div>
            </div>`).join('');

        // REGU
        document.getElementById('v-regu').innerHTML = db.teams.map((t, i) => `
            <div class="card">
                <div style="font-weight:800; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:10px;">${t.name}</div>
                <div style="display:flex; flex-wrap:wrap; gap:6px;">${t.players.map(p => `<span style="background:var(--gray); padding:5px 10px; border-radius:8px; font-size:11px; font-weight:600;">${p}</span>`).join('')}</div>
                ${isAdmin ? `<div style="display:flex; gap:5px; margin-top:12px;"><input type="text" id="inp-p-${i}" placeholder="Nama pemain..."><button class="btn btn-accent" style="width:70px; margin:0; padding:8px" onclick="addPlayer(${i})">Add</button></div>` : ''}
            </div>`).join('');

        // ADMIN MATCH LIST
        if(isAdmin) {
            document.getElementById('v-admin-matches').innerHTML = `<h4 style="margin:20px 0 10px 5px">Kelola Skor Match</h4>` + 
            db.matches.map((m, i) => `<div class="card" onclick="openEdit(${i})" style="cursor:pointer; border-left:5px solid var(--accent)"><b>${m.a} vs ${m.b}</b><br><small style="color:var(--text-muted)">Klik untuk input pemain & skor</small></div>`).join('');
        }
    }

    function openEdit(i) {
        currentEditIdx = i;
        const m = db.matches[i];
        const teamA = db.teams.find(t => t.name === m.a) || {players:[]};
        const teamB = db.teams.find(t => t.name === m.b) || {players:[]};
        
        document.getElementById('editTitle').innerText = `${m.a} vs ${m.b}`;
        document.getElementById('editTime').value = m.time || "";

        let html = "";
        ["Partai 1 (S)", "Partai 2 (D)", "Partai 3 (D)"].forEach((pLabel, idx) => {
            const d = (m.detail && m.detail[idx]) ? m.detail[idx] : {};
            const optA = teamA.players.map(p => `<option value="${p}" ${d.p1A === p || d.p2A === p ? 'selected' : ''}>${p}</option>`).join('');
            const optB = teamB.players.map(p => `<option value="${p}" ${d.p1B === p || d.p2B === p ? 'selected' : ''}>${p}</option>`).join('');

            html += `<div class="partai-box">
                <div style="font-size:10px; font-weight:bold; margin-bottom:8px; color:var(--primary)">${pLabel}</div>
                <div style="display:grid; grid-template-columns: 1fr 30px 1fr; gap:8px;">
                    <div>
                        <select class="p-p1A"><option value="">Pemain 1</option>${optA}</select>
                        ${idx > 0 ? `<select class="p-p2A" style="margin-top:5px;"><option value="">Pemain 2</option>${optA}</select>` : ''}
                        <input type="number" class="p-scA" placeholder="Skor" value="${d.scA || ''}" style="margin-top:5px; font-weight:bold; text-align:center;">
                    </div>
                    <div style="text-align:center; padding-top:15px; font-weight:bold; opacity:0.2">VS</div>
                    <div>
                        <select class="p-p1B"><option value="">Pemain 1</option>${optB}</select>
                        ${idx > 0 ? `<select class="p-p2B" style="margin-top:5px;"><option value="">Pemain 2</option>${optB}</select>` : ''}
                        <input type="number" class="p-scB" placeholder="Skor" value="${d.scB || ''}" style="margin-top:5px; font-weight:bold; text-align:center;">
                    </div>
                </div>
            </div>`;
        });
		let lapHtml = `
		<label style="font-size:10px; font-weight:bold;">LAPANGAN:</label>
		<select id="editLap">
			<option value="">Pilih Lapangan</option>
			<option value="LAP 1" ${m.lap === 'LAP 1' ? 'selected' : ''}>LAPANGAN 1</option>
			<option value="LAP 2" ${m.lap === 'LAP 2' ? 'selected' : ''}>LAPANGAN 2</option>
			<option value="LAP 3" ${m.lap === 'LAP 3' ? 'selected' : ''}>LAPANGAN 3</option>
		</select>`;
        document.getElementById('partaiInputs').innerHTML = html;
        document.getElementById('editOverlay').style.display = 'block';
    }

    async function saveEdit() {
        const i = currentEditIdx;
        const boxes = document.querySelectorAll('.partai-box');
		const lapVal = document.getElementById('editLap').value; // Ambil nilai lapangan
        let winA = 0, winB = 0, detail = [];
        
        boxes.forEach((box) => {
            const scA = parseInt(box.querySelector('.p-scA').value || 0);
            const scB = parseInt(box.querySelector('.p-scB').value || 0);
            detail.push({
                p1A: box.querySelector('.p-p1A').value,
                p2A: box.querySelector('.p-p2A') ? box.querySelector('.p-p2A').value : "",
                p1B: box.querySelector('.p-p1B').value,
                p2B: box.querySelector('.p-p2B') ? box.querySelector('.p-p2B').value : "",
                scA: scA, scB: scB
            });
            if(scA > scB) winA++; else if(scB > scA) winB++;
        });

        db.matches[i].time = document.getElementById('editTime').value;
        db.matches[i].sa = winA;
        db.matches[i].sb = winB;
        db.matches[i].detail = detail;
		db.matches[i].lap = lapVal; // Simpan ke objek db
        
        const data = [["A","B","T","SA","SB","DET","LAP"], ...db.matches.map(m => [m.a, m.b, m.time, m.sa, m.sb, JSON.stringify(m.detail),m.lap||""])];
        closeEdit();
        await sync('saveAll', 'Matches', data);
    }

    function closeEdit() { document.getElementById('editOverlay').style.display = 'none'; }
    function checkPass() { document.getElementById('admin-tools').style.display = document.getElementById('pass').value === PW ? 'block' : 'none'; render(); }
    function tab(id) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        document.getElementById('b-' + id).classList.add('active'); 
    }
    async function addTeam() { 
        const n = document.getElementById('t-name').value; 
        if(n) { 
            db.teams.push({name:n, players:[]}); 
            const d = [["Nama", "Pemain"], ...db.teams.map(t => [t.name, JSON.stringify(t.players)])];
            document.getElementById('t-name').value = "";
            await sync('saveAll', 'Teams', d); 
        } 
    }
    async function addPlayer(i) { 
        const n = document.getElementById(`inp-p-${i}`).value; 
        if(n) { 
            db.teams[i].players.push(n); 
            const d = [["Nama", "Pemain"], ...db.teams.map(t => [t.name, JSON.stringify(t.players)])];
            await sync('saveAll', 'Teams', d); 
        } 
    }
    async function genJadwal() { 
        if(!confirm("Hapus semua skor dan jadwal?")) return; 
        let m = [["A","B","T","SA","SB","DET"]]; 
        for(let i=0; i<db.teams.length; i++) for(let j=i+1; j<db.teams.length; j++) m.push([db.teams[i].name, db.teams[j].name, "", "", "", ""]); 
        await sync('saveAll', 'Matches', m); 
    }

    loadAll();
</script>
</body>
</html>

